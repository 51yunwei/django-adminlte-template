{% extends 'base.html' %} 
{% load static %}                                 
{% block head %}

{% endblock %}
{% block pageheader %}系统管理{% endblock %}
{% block content %}
<section class="content">
    <div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
        <div class="card card-info">
            <div class="card-header">
              <h3 class="card-title">系统设置</h3>
            </div>
            <form class="form-horizontal" id='systemForm' novalidate="novalidate" enctype="multipart/form-data" >
              <div class="card-body">
                <div class="form-group row">
                  <label for="title" class="col-sm-2 col-form-label"><a style="color: red;">*</a> Tilte</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="title" name="title" placeholder="网页title" value="{{ systeminfo.system_title }}">
                  </div>
                </div>
                <div class="form-group row">
                  <label for="systemname" class="col-sm-2 col-form-label"><a style="color: red;">*</a> 系统名称</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="systemname" name="systemname" placeholder="系统名称" value="{{ systeminfo.system_name }}">
                  </div>
                </div>
                <div class="form-group row">
                  <div class="offset-sm-2 col-sm-10">
                  </div>
                </div>
                
              </div>
              
              <div class="card-footer">
                <button type="submit" class="btn btn-info">保存&提交</button>
                <a href="javascript:history.go(-1);" class="btn btn-success float-right"></i> 取消</a>
              </div>
              
            </form>
          </div>
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">更多设置</h3>
    
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body" style="display: block;">
              <div class="form-group">
                <label for="logoimg">站点图标(33x33)</label>
                <div class="file-loading"> 
                    <input id="logoimg" name="logoimg" type="file">
                </div>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
        </div>
    </div>
    
    </div>
    </section>
{% endblock %}
{% block script %}
<script src="{% static 'adminlte/plugins/bs-custom-file-input/bs-custom-file-input.js' %}"></script>
<!-- bootstrap 5.x or 4.x is supported. You can also use the bootstrap css 3.3.x versions -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" crossorigin="anonymous"> -->

<!-- default icons used in the plugin are from Bootstrap 5.x icon library (which can be enabled by loading CSS below) -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.min.css" crossorigin="anonymous"> -->

<!-- alternatively you can use the font awesome icon library if using with `fas` theme (or Bootstrap 4.x) by uncommenting below. -->
<!-- link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" crossorigin="anonymous" -->

<!-- the fileinput plugin styling CSS file -->
<link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />

<!-- if using RTL (Right-To-Left) orientation, load the RTL CSS file after fileinput.css by uncommenting below -->
<!-- link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/css/fileinput-rtl.min.css" media="all" rel="stylesheet" type="text/css" /-->

<!-- the jQuery Library -->
<!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script> -->

<!-- buffer.min.js and filetype.min.js are necessary in the order listed for advanced mime type parsing and more correct
     preview. This is a feature available since v5.5.0 and is needed if you want to ensure file mime type is parsed 
     correctly even if the local file's extension is named incorrectly. This will ensure more correct preview of the
     selected file (note: this will involve a small processing overhead in scanning of file contents locally). If you 
     do not load these scripts then the mime type parsing will largely be derived using the extension in the filename
     and some basic file content parsing signatures. -->
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/js/plugins/buffer.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/js/plugins/filetype.min.js" type="text/javascript"></script>

<!-- piexif.min.js is needed for auto orienting image files OR when restoring exif data in resized images and when you
    wish to resize images before upload. This must be loaded before fileinput.min.js -->
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/js/plugins/piexif.min.js" type="text/javascript"></script>

<!-- sortable.min.js is only needed if you wish to sort / rearrange files in initial preview. 
    This must be loaded before fileinput.min.js -->
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/js/plugins/sortable.min.js" type="text/javascript"></script>

<!-- bootstrap.bundle.min.js below is needed if you wish to zoom and preview file content in a detail modal
    dialog. bootstrap 5.x or 4.x is supported. You can also use the bootstrap js 3.3.x versions. -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script> -->

<!-- the main fileinput plugin script JS file -->
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/js/fileinput.min.js"></script>

<!-- following theme script is needed to use the Font Awesome 5.x theme (`fas`). Uncomment if needed. -->
<!-- script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/themes/fas/theme.min.js"></script -->

<!-- optionally if you need translation for your language then include the locale file as mentioned below (replace LANG.js with your language locale) -->
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.2/js/locales/LANG.js"></script>
<script>
  $("#logoimg").fileinput({
        showUpload: true,
        dropZoneEnabled: false,
        maxFileCount: 10,
        inputGroupClass: "input-group-lg",
        allowedFileExtensions: ["png"],
        language: 'zh',
        uploadUrl: "{% url 'manager:system' %}",
        
    }).on("fileuploaded", function (e,data,previewId,index) {
                // 上传成功后触发的事件
                toastr.success('修改站点图标成功,当前界面可能有缓存,如未更新,请强制刷新一次')
                setTimeout(function() {
                    location.reload();
                }, 3000);
            });

    $(document).ready(function(){
        var Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
        });
        $("#systemForm button[type='submit']").click(function(e){
            e.preventDefault(); // 阻止表单的默认提交行为
            // 先进行表单验证
            if (!$("#systemForm").valid()) {
                // 如果验证失败，返回false，不提交数据
                return false;
            };
            var formData = $("#systemForm").serialize();
            $.ajax({
                url: "{% url 'manager:system' %}", // 你的请求地址
                type: "POST", // 请求类型，必须是POST
                data: formData, // 你的表单数据
                dataType: "json", // 返回的数据类型，必须是json
                success: function(data){
                    if (data.result === 0) {
                        // 请求成功，显示消息
                        toastr.success(data.message)
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else if (data.result === 1) {
                        toastr.error(data.message)
                    }
                },
                error: function(){
                    // 请求失败的回调函数
                    console.log("Error");
                }
            });
        });
        // 表单验证
        // $("#savebtn").prop('disabled', true);
    $('#systemForm').validate({
          rules: {
            title: {
              required: true,
            },
            systemname: {
              required: true,
            },
          },
          messages: {
            title: {
              required: "title不能为空",
            },
            systemname: {
              required: "系统名称不能为空",
            },
          },
          errorElement: 'span',
          errorPlacement: function (error, element) {
            error.addClass('invalid-feedback');
            element.closest('.form-group').append(error);
           
          },
          highlight: function (element, errorClass, validClass) {
            $(element).addClass('is-invalid');
           
          },
          unhighlight: function (element, errorClass, validClass) {
            $(element).removeClass('is-invalid');
          },
          
        });
    });
    </script>
{% endblock %}